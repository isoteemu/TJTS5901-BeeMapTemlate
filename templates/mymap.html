<!DOCTYPE HTML>
<html>

<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
  <style>
    html,
    body {
      height: 100%;
      padding: 0;
      margin: 0;
    }

    #map {
      /* configure the size of the map */
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    // initialize Leaflet
    var map = L.map('map').setView({ lon: 25.72088, lat: 62.24147 }, 15.5);

    // add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(map);

    // show the scale bar on the lower left corner
    L.control.scale().addTo(map);

    // show a marker on the map
    {% for item in hive_locations %}
      L.marker({{item | tojson}}).bindPopup('spam').addTo(map);
    {% endfor %}
    
    //Array of all the markers that we create
    var allMarkers = [];

    // Function saves beehive's location to database and to local map
    function savePopup() {
      //Data that we want to send to server and save as a beehive location
      var data = document.getElementById("edit").value;

      //HTTP request to server
      var request = new XMLHttpRequest();
      request.open('POST', '/save', true);
      request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      request.send(data);
      alert(data + ' was saved to database!')
      saveValue()
    }

    function saveValue() {
      document.getElementById("loc").innerHTML = document.getElementById("edit").value
  
    }

    //Create GeoJSON layer for user generated data
    var drawnItems = new L.geoJson();
    //Add GeoJSON layer to map
    map.addLayer(drawnItems);

    // Leaflet draw event
    map.on('dblclick', function (e) {
      var marker = L.marker(e.latlng).addTo(map);
      var markerpopup = L.popup({});
      //Set popup lat lng where clicked
      markerpopup.setLatLng(e.latlng);
      //lat lng where clicked to string
      var placement = e.latlng.toString()
      //Set popup content
      markerpopup.setContent('<form><label style="font-weight: bold;">Beehive location: </label><label id="loc">Unknown</label><br /><label style="font-weight: bold;">Set a new location: </label><input id="edit" name="edit" onvaluechange="saveValue()" value="Type here"/></form><button onclick="savePopup()">Save</button>');
      //Bind marker popup
      marker.bindPopup(markerpopup);
      //Add marker to geojson layer
      drawnItems.addLayer(marker);

      allMarkers.push(marker)
    });

    // Functin to delete a beehive in the map
    /* function deletePopup() {
      map.removeLayer(drawnItems)

      var request = new XMLHttpRequest();
      request.open('DELETE', '/delete', true);
      request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
      request.send(data);
      alert('Marker was saved to database!')
    } */

  </script>
</body>
</html>